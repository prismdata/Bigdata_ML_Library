package org.ankus.mapreduce.algorithms.clustering.FuzzyCMeans;

import java.io.IOException;
import java.text.DecimalFormat;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.Map.Entry;

import org.ankus.util.ArgumentsConstants;
import org.apache.hadoop.conf.Configuration;
import org.apache.hadoop.io.Text;
import org.apache.hadoop.mapreduce.Reducer;
import org.apache.hadoop.mapreduce.Reducer.Context;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

//각 feature마다 하나씩 할당.
class Centroid
{
	double weight = 0.0;
	
	double weightedAttribute = 0.0;
}
public class Reducer_Centroid extends Reducer<Text, Text, Text, Text> {
	private Logger logger = LoggerFactory.getLogger(Reducer_Centroid.class);
	String delimiter = "";
	@Override
	protected void setup(Context context) throws IOException, InterruptedException
	{
		logger.info("setup");
		Configuration conf = context.getConfiguration();
		delimiter = conf.get(ArgumentsConstants.DELIMITER);
	}
	
	protected void reduce(Text CluserK, Iterable<Text> weightNwVector, Context context) throws IOException, InterruptedException
	{
		String ClusterKey = CluserK.toString();
		Double sumOfweight2 = 0.0;
		Double sumofWeightedAttrbute = 0.0;
		
		//element index, colument
		HashMap<String, List<Double>> HashElement = new HashMap<String, List<Double>>();
		HashMap<String, Double> newCentroid = new HashMap<String, Double>();
//		Iterator itr = weightNwVector.iterator();
		//index마다 Summary of Weight, WeightedAttribute를 계산.
		//weightNwVector에 개별 개체의 모든 속성 정보가 들어가 있음.
		//출력은 Cluster ID, index, new Centroid가 됨.
		HashMap<Integer , Centroid> hashCentroid = new HashMap<Integer, Centroid>();
		int Attr_Idx = 0;
		for(Text wNwe: weightNwVector)
		{
//			****split weight  weighted element
			String[] indexNWeigthEleVector  = wNwe.toString().split("\u0001");
			Attr_Idx = Integer.parseInt(indexNWeigthEleVector[0]);
			
			String[] w_we = indexNWeigthEleVector[1].split("\u0002");
			
			double weight = Double.parseDouble(w_we[0]);
			
			if(hashCentroid.containsKey(Attr_Idx) == true)
			{
				Centroid centroid = hashCentroid.get(Attr_Idx);
				centroid.weight += Math.pow(weight, 2);
				centroid.weightedAttribute += Double.parseDouble(w_we[1]);
			}
			else
			{
				Centroid centroid = new Centroid();
				centroid.weight += Math.pow(weight, 2);
				centroid.weightedAttribute += Double.parseDouble(w_we[1]);
				hashCentroid.put(Attr_Idx, centroid);
			}
		}
		for( Map.Entry<Integer, Centroid> ClusterCentroid : hashCentroid.entrySet() )
		{
//			System.out.println( String.format("키 : %s, 값 : %s", elem.getKey(), elem.getValue()) );
			Attr_Idx = ClusterCentroid.getKey();
			
			Centroid centroid = ClusterCentroid.getValue();
			
			double wa = centroid.weightedAttribute;
			double w = centroid.weight;
			DecimalFormat format = new DecimalFormat("0.####");
			String formNum = format.format(wa/w);
			System.out.println("\nClusterID: "+ ClusterKey + "->" + Attr_Idx + "," + formNum);
			context.write(new Text(ClusterKey), new Text(Attr_Idx + "," + formNum));
        }
         
	}
}
